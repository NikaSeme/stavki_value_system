{
  "objective": "Require explicit manual-run choices and prompt the user for bankroll and target average EV on every manual run, while keeping automated/scheduled runs non-interactive.",
  "definition_of_manual_run": {
    "rule": "A run is manual if stdin is a TTY and --auto/--non-interactive is NOT set.",
    "non_interactive_overrides": [
      "--auto",
      "--non-interactive",
      "STAVKI_AUTOMATED=1",
      "not sys.stdin.isatty()"
    ]
  },
  "requirements": {
    "choice_on_every_manual_run": "Present a menu before any execution path (odds + value, value-only, view-only, dry-run, exit).",
    "mandatory_inputs": {
      "bankroll": "User must type a positive number (float).",
      "target_avg_ev_pct": "User must type desired average EV in percent (0-100)."
    },
    "validation": {
      "bankroll": "reject <= 0, non-numeric, or unrealistically large values unless user confirms",
      "target_avg_ev_pct": "reject < 0 or > 100"
    },
    "non_interactive_mode": "Must allow scheduler/systemd/cron to run without prompts by passing --auto or --non-interactive."
  },
  "files_to_change": [
    {
      "path": "scripts/run_value_finder.py",
      "purpose": "Primary manual run entrypoint (live value finder).",
      "changes": [
        "Add CLI flags: --interactive/--non-interactive (default: auto-detect), --auto (alias of non-interactive), --target-avg-ev (float percent).",
        "Add a pre-run interactive menu when manual (TTY + not auto).",
        "Prompt for bankroll and target_avg_ev_pct on every manual run; override any CLI defaults with typed input.",
        "Store typed values and pass bankroll into compute_ev_candidates; store target_avg_ev_pct for selection logic.",
        "Implement target average EV logic: if average EV of final bets < target, either (a) raise ev_threshold iteratively until target is reached or no bets, or (b) prompt user to continue/cancel with current average."
      ],
      "menu_spec": {
        "options": [
          "1: Fetch odds + run value finder",
          "2: Run value finder using latest odds only",
          "3: View top-N only (no alerts)",
          "4: Dry-run",
          "5: Exit"
        ],
        "notes": "Always show menu on manual runs before any processing. Respect selection to set flags (--dry-run, --top, etc.)."
      },
      "input_prompts": {
        "bankroll": "Enter bankroll (e.g., 1000): ",
        "target_avg_ev_pct": "Enter target average EV % (e.g., 8 for 8%): "
      },
      "selection_logic": {
        "avg_ev_target_usage": [
          "Compute avg_ev of final_bets (mean of ev_pct).",
          "If avg_ev < target_avg_ev_pct: increase ev_threshold in small steps (e.g., +0.01) and re-filter until avg_ev >= target or no bets.",
          "If no bets meet target: display warning and ask user to proceed or abort."
        ]
      }
    },
    {
      "path": "src/strategy/value_live.py",
      "purpose": "Use user-provided bankroll for stake sizing instead of fixed 1000.",
      "changes": [
        "Update compute_ev_candidates(...) signature to accept bankroll (float) and use it instead of hard-coded 1000.0.",
        "Add input validation (bankroll > 0) and fallback to 1000.0 only in non-interactive mode with warning log."
      ]
    },
    {
      "path": "src/cli.py",
      "purpose": "Manual pipeline run via CLI should also enforce typed inputs when interactive.",
      "changes": [
        "Add --interactive/--non-interactive flags to the run command.",
        "When interactive and TTY, prompt for bankroll and target_avg_ev_pct regardless of whether options were passed; override values with typed input.",
        "Add optional --target-avg-ev to run; implement the same average EV gating logic (or warnings) used in run_value_finder."
      ]
    },
    {
      "path": "scripts/run_scheduler.py",
      "purpose": "Ensure scheduled runs bypass prompts.",
      "changes": [
        "Pass --auto or --non-interactive to scripts/run_value_finder.py.",
        "If odds fetching is orchestrated, also pass --auto to odds pipeline."
      ]
    },
    {
      "path": "README.md",
      "purpose": "Document interactive manual run behavior and new flags.",
      "changes": [
        "Add a note that manual runs require typed bankroll + target average EV.",
        "Show non-interactive examples for scheduler/systemd/cron using --auto."
      ]
    },
    {
      "path": "README_V5.md",
      "purpose": "Keep production docs in sync with new interactive/manual behavior.",
      "changes": [
        "Add examples for manual run with prompts and automated run with --auto."
      ]
    }
  ],
  "implementation_details": {
    "helper_functions": [
      "prompt_float(label, min_value=None, max_value=None)",
      "is_manual_run() -> bool (TTY + not auto)",
      "manual_menu() -> selection enum"
    ],
    "data_flow": [
      "manual_menu -> set run mode (odds+value/value-only/top/dry-run/exit)",
      "prompt bankroll + target_avg_ev_pct",
      "pass bankroll into compute_ev_candidates",
      "apply target average EV gating to final selection",
      "log the chosen values and decision in output logs"
    ],
    "logging": [
      "Log the user-entered bankroll and target average EV (mask if you consider them sensitive).",
      "Log whether the run was manual or auto.",
      "Log if target avg EV could not be met and whether the user overrode."
    ]
  },
  "acceptance_tests": [
    "Manual run (TTY) of scripts/run_value_finder.py shows menu, then prompts for bankroll and target EV, and blocks until values are provided.",
    "Manual run cannot proceed with empty/invalid bankroll or EV inputs.",
    "Scheduler run executes without prompts when --auto is used.",
    "Stake values in output reflect the user-entered bankroll (not hard-coded 1000).",
    "If target average EV is unattainable, the run warns and requires explicit confirmation to proceed."
  ],
  "non_goals": [
    "Do not change the ML models or betting math beyond using the provided bankroll.",
    "Do not enable auto-betting by default; keep DRY_RUN and explicit enable flags intact."
  ]
}