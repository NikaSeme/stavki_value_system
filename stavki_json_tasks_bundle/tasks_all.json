{
  "project_name": "stavki_value_system",
  "language": "python",
  "style_rules": {
    "code_quality": [
      "type hints everywhere",
      "no hardcoded secrets",
      "use dataclasses for configs",
      "write unit tests for core math",
      "log every step"
    ],
    "runtime": [
      "python 3.11+",
      "works on macOS and Ubuntu",
      "no GPU required for MVP"
    ]
  },
  "global_constraints": {
    "no_illegal_actions": [
      "Do NOT include instructions to bypass bookmaker security or ToS.",
      "Auto-betting must be optional and disabled by default."
    ],
    "safety": [
      "Implement DRY_RUN mode default true",
      "Require explicit flag to enable any execution module"
    ]
  },
  "deliverable_format": {
    "output": "Multiple files",
    "must_include": [
      "README.md with step-by-step run instructions",
      "requirements.txt",
      ".env.example",
      "src/ package with modules",
      "tests/ with pytest tests",
      "logs/ ignored by git"
    ]
  },
  "tasks": [
    {
      "id": "T001_bootstrap",
      "goal": "Create project scaffold and dependency setup",
      "inputs": {
        "plan_file_summary": "System for value betting: data ingestion, models A/B/C, ensemble, calibration, EV filter, staking, backtest, notifications, optional execution."
      },
      "outputs": [
        "pyproject.toml or requirements.txt",
        "README.md",
        ".env.example",
        ".gitignore",
        "src/__init__.py",
        "src/config.py",
        "src/logging_setup.py"
      ],
      "acceptance_tests": [
        "python -m src.cli --help works",
        "logging writes to logs/app.log",
        "config loads from .env"
      ]
    },
    {
      "id": "T010_data_ingestion",
      "goal": "Implement data ingestion for football CSV (football-data style) and normalized match table",
      "inputs": {
        "data_sources": [
          "local CSV files in data/raw/",
          "optional downloader from URL list"
        ]
      },
      "outputs": [
        "src/data/ingest_football_data.py",
        "src/data/schema.py",
        "src/data/storage.py"
      ],
      "acceptance_tests": [
        "Loads CSV -> produces normalized dataframe with columns: date, league, home_team, away_team, home_goals, away_goals, odds_1, odds_x, odds_2",
        "Handles missing odds gracefully"
      ]
    },
    {
      "id": "T020_features",
      "goal": "Build feature engineering pipeline with leakage-safe rolling stats",
      "inputs": {
        "features": [
          "rolling goals for/against last 5",
          "points last 5",
          "home advantage flag",
          "optional elo feature placeholder"
        ],
        "leakage_rule": "Only use matches strictly before current match date"
      },
      "outputs": [
        "src/features/build_features.py"
      ],
      "acceptance_tests": [
        "For a given match row, features computed only from earlier games",
        "Unit test checks leakage with synthetic timestamps"
      ]
    },
    {
      "id": "T030_model_A",
      "goal": "Implement Model A: Poisson baseline for 1X2 probabilities",
      "inputs": {
        "max_goals": 10,
        "parameters": [
          "league_avg_home_goals",
          "league_avg_away_goals",
          "team_attack_strength",
          "team_defense_strength"
        ]
      },
      "outputs": [
        "src/models/model_a_poisson.py",
        "tests/test_model_a_poisson.py"
      ],
      "acceptance_tests": [
        "Probabilities sum to ~1",
        "Favorite vs underdog produces higher win prob",
        "Deterministic given same inputs"
      ]
    },
    {
      "id": "T040_model_B",
      "goal": "Implement Model B: LightGBM multiclass with time split training and saved artifact",
      "inputs": {
        "target": "result_1x2",
        "train_split": "time_based",
        "metrics": [
          "logloss"
        ]
      },
      "outputs": [
        "src/models/model_b_lgbm.py",
        "src/models/train_b.py",
        "src/models/persist.py",
        "tests/test_model_b_shapes.py"
      ],
      "acceptance_tests": [
        "Training script saves model to models/",
        "Predict_proba returns shape (n,3)"
      ]
    },
    {
      "id": "T050_ensemble_calibration",
      "goal": "Implement ensemble (stacking) and probability calibration",
      "inputs": {
        "base_models": [
          "A",
          "B"
        ],
        "meta_model": "multinomial logistic regression",
        "calibration": "isotonic per-class + renormalization"
      },
      "outputs": [
        "src/models/ensemble.py",
        "src/models/calibration.py",
        "tests/test_calibration_sums_to_one.py"
      ],
      "acceptance_tests": [
        "Final probs sum to 1",
        "Calibration can be fit and applied"
      ]
    },
    {
      "id": "T060_ev_and_staking",
      "goal": "Implement EV calculation, filtering, and fractional Kelly staking with caps",
      "inputs": {
        "ev_threshold": 0.08,
        "kelly_fraction": 0.5,
        "max_stake_frac": 0.05
      },
      "outputs": [
        "src/strategy/ev.py",
        "src/strategy/staking.py",
        "tests/test_kelly.py"
      ],
      "acceptance_tests": [
        "EV = p*odds - 1",
        "Kelly stake non-negative and capped",
        "Edge cases: odds<=1 handled"
      ]
    },
    {
      "id": "T070_backtest",
      "goal": "Implement backtesting pipeline and reporting",
      "inputs": {
        "mode": "walk_forward",
        "outputs": [
          "csv log",
          "summary stats"
        ]
      },
      "outputs": [
        "src/backtest/run_backtest.py",
        "src/backtest/metrics.py"
      ],
      "acceptance_tests": [
        "Backtest runs end-to-end on sample data",
        "Outputs ROI, winrate, max drawdown"
      ]
    },
    {
      "id": "T080_notifications",
      "goal": "Send Telegram alerts for found value bets (optional)",
      "inputs": {
        "env_vars": [
          "TELEGRAM_BOT_TOKEN",
          "TELEGRAM_CHAT_ID"
        ]
      },
      "outputs": [
        "src/notify/telegram.py"
      ],
      "acceptance_tests": [
        "If env vars missing -> degrade gracefully",
        "Message format includes match, market, odds, p, EV, stake"
      ]
    },
    {
      "id": "T090_cli",
      "goal": "Create CLI entrypoints to run pipeline steps",
      "inputs": {
        "commands": [
          "ingest",
          "train",
          "predict",
          "backtest"
        ]
      },
      "outputs": [
        "src/cli.py"
      ],
      "acceptance_tests": [
        "python -m src.cli ingest works",
        "python -m src.cli backtest works"
      ]
    }
  ]
}