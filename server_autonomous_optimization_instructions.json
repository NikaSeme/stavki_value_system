{
  "analysis_date": "2026-01-27",
  "project_root": "/Users/macuser/Documents/something/stavki_value_system",
  "summary": "Detailed fixes/improvements plus server-autonomous optimization steps.",
  "fixes_and_improvements": [
    {
      "id": "F01_orchestrate_odds_then_value",
      "issue": "Scheduler runs value finder without guaranteed fresh odds. run_value_finder expects outputs/odds/events_latest_*.csv.",
      "impact": "Scheduled runs can fail or use stale data.",
      "files": [
        "scripts/run_scheduler.py",
        "scripts/run_odds_pipeline.py",
        "README.md",
        "README_V5.md"
      ],
      "recommendation": "Update scheduler to run odds pipeline first (with --track-lines if desired), verify outputs, then run value finder. Add explicit logging and exit codes; update docs accordingly."
    },
    {
      "id": "F02_top_ev_bets_output",
      "issue": "run_telegram_bot.py expects audit_pack/A9_live/top_ev_bets.csv but run_value_finder.py does not create it.",
      "impact": "Telegram /top command and audit validation can fail.",
      "files": [
        "scripts/run_value_finder.py",
        "scripts/run_telegram_bot.py"
      ],
      "recommendation": "Write top_ev_bets.csv on every successful run (non-dry-run). Include fields used by bot: home_team, away_team, selection, odds, ev_pct, stake_pct."
    },
    {
      "id": "F03_cli_placeholders",
      "issue": "CLI commands analyze/backtest/monitor in src/cli.py are placeholders.",
      "impact": "Primary CLI is incomplete; users must use scripts directly.",
      "files": [
        "src/cli.py",
        "scripts/run_backtest_v3_4.py",
        "src/pipeline/run_pipeline.py"
      ],
      "recommendation": "Implement CLI commands or remove them from docs. At minimum, wire analyze to run_pipeline, backtest to run_backtest_v3_4, and monitor to scheduler/loop."
    },
    {
      "id": "F04_scheduler_docs_mismatch",
      "issue": "README examples show run_scheduler.py flags (--interval/--max-runs), but the script has no CLI args; timezone in README_V5 differs from script.",
      "impact": "Operators will run incorrect commands or schedule at the wrong time.",
      "files": [
        "README.md",
        "README_V5.md",
        "scripts/run_scheduler.py"
      ],
      "recommendation": "Either add CLI args or update docs to fixed schedule. Explicitly document timezone and match logs to that timezone."
    },
    {
      "id": "F05_bankroll_hardcoded",
      "issue": "compute_ev_candidates in src/strategy/value_live.py uses bankroll=1000.0 for stake sizing.",
      "impact": "Stake sizing ignores real bankroll and manual run inputs.",
      "files": [
        "src/strategy/value_live.py",
        "scripts/run_value_finder.py",
        "src/cli.py"
      ],
      "recommendation": "Pass bankroll through from CLI/run_value_finder and use it in stake sizing."
    },
    {
      "id": "F06_multileague_artifacts_missing",
      "issue": "config/leagues/*.yaml references model paths for laliga/bundesliga that do not exist; data/historical is missing.",
      "impact": "Multi-league mode fails or skips leagues.",
      "files": [
        "config/leagues/*.yaml",
        "models/*",
        "data/historical/*"
      ],
      "recommendation": "Add league-specific historical datasets, train models, and update configs or disable unsupported leagues."
    },
    {
      "id": "F07_basketball_model_missing",
      "issue": "run_value_finder expects models/catboost_basketball.cbm; config/leagues.yaml marks basketball active.",
      "impact": "Basketball leagues are skipped silently.",
      "files": [
        "models/catboost_basketball.cbm",
        "config/leagues.yaml"
      ],
      "recommendation": "Train or supply a basketball model or disable basketball leagues in config until available."
    },
    {
      "id": "F08_interactive_vs_automated",
      "issue": "Manual run prompts are not enforced; scheduler does not pass a non-interactive flag.",
      "impact": "Manual safety requirements are not guaranteed; scheduled runs may block if prompts are added later.",
      "files": [
        "scripts/run_value_finder.py",
        "scripts/run_scheduler.py",
        "src/cli.py"
      ],
      "recommendation": "Implement explicit --auto/--non-interactive and --interactive modes and ensure schedulers pass --auto."
    },
    {
      "id": "F09_logs_and_retention",
      "issue": "Logs and audit files can grow without rotation or retention policy.",
      "impact": "Disk usage grows unbounded; server stability risk.",
      "files": [
        "audit_pack/*",
        "logs/*",
        "outputs/*"
      ],
      "recommendation": "Implement log rotation and retention cleanup (cron/systemd-tmpfiles)."
    },
    {
      "id": "F10_secrets_management",
      "issue": "A .env file exists in repo; secrets should not be committed or logged.",
      "impact": "Key exposure risk.",
      "files": [
        ".env",
        ".env.example",
        "README.md"
      ],
      "recommendation": "Move secrets to systemd EnvironmentFile with strict permissions; add .env to .gitignore if not already."
    }
  ],
  "server_autonomous_optimization": {
    "goals": [
      "Run odds + value pipeline reliably without manual intervention",
      "Prevent overlapping runs",
      "Ensure secrets are protected",
      "Provide auditability and log retention",
      "Support restarts and recoveries"
    ],
    "setup_steps": [
      {
        "step": "Create service user and directories",
        "details": [
          "Create a dedicated Linux user (e.g., stavki).",
          "Create directories: /opt/stavki_value_system, /var/log/stavki, /var/lib/stavki, /etc/stavki.",
          "Set ownership to the service user."
        ]
      },
      {
        "step": "Install dependencies",
        "details": [
          "Install Python 3.11+ and system build tools.",
          "Create a virtual environment in /opt/stavki_value_system/venv.",
          "Install requirements.txt inside the venv."
        ]
      },
      {
        "step": "Configure secrets",
        "details": [
          "Create /etc/stavki/stavki.env with ODDS_API_KEY, TELEGRAM_BOT_TOKEN, TELEGRAM_CHAT_ID, etc.",
          "Set permissions: chmod 600, owned by service user.",
          "Do not store secrets in repo; keep .env.example for reference only."
        ]
      },
      {
        "step": "Configure non-interactive operation",
        "details": [
          "Ensure scheduler calls run_value_finder with --auto or --non-interactive.",
          "If manual prompts are added, they must be gated by isatty + not --auto."
        ]
      },
      {
        "step": "Add process lock",
        "details": [
          "Implement a file lock (e.g., /var/lib/stavki/lock) in run_scheduler or run_value_finder to prevent concurrent runs.",
          "Exit gracefully if lock exists."
        ]
      },
      {
        "step": "Add run orchestration",
        "details": [
          "Run odds pipeline first: python3 scripts/run_odds_pipeline.py --track-lines",
          "Validate outputs/odds/events_latest_*.csv exists and is recent before running value finder.",
          "Then run: python3 scripts/run_value_finder.py --now --telegram --auto."
        ]
      },
      {
        "step": "Systemd service and timer",
        "details": [
          "Create /etc/systemd/system/stavki.service to run the combined pipeline.",
          "Use WorkingDirectory=/opt/stavki_value_system, EnvironmentFile=/etc/stavki/stavki.env.",
          "Set Restart=on-failure, TimeoutStartSec=600, and nice values to limit CPU.",
          "Create /etc/systemd/system/stavki.timer to schedule runs (e.g., OnCalendar=*-*-* 12,22:00:00 UTC).",
          "Enable timer: systemctl enable --now stavki.timer."
        ]
      },
      {
        "step": "Logging",
        "details": [
          "Set StandardOutput=append:/var/log/stavki/stavki.log and StandardError=append:/var/log/stavki/stavki.err.",
          "Keep app logs in logs/app.log via existing logging_setup.",
          "Set PYTHONUNBUFFERED=1 for timely logs."
        ]
      },
      {
        "step": "Log rotation and retention",
        "details": [
          "Configure logrotate for /var/log/stavki/*.log (weekly, 4-8 rotations).",
          "Add cleanup cron for audit_pack and outputs older than N days (e.g., 14/30 days)."
        ]
      },
      {
        "step": "Health checks and alerts",
        "details": [
          "Add a simple health script that validates last successful run timestamp and alerts if stale.",
          "Send a Telegram health alert if no runs in the last 24h or if odds fetch fails repeatedly."
        ]
      },
      {
        "step": "Backups",
        "details": [
          "Back up audit_pack/A9_live, models/, and config/ to off-box storage on a schedule.",
          "Store model artifacts and metadata hashes to detect drift."
        ]
      }
    ]
  },
  "suggested_systemd_templates": {
    "stavki.service": [
      "[Unit]",
      "Description=Stavki Value Betting Pipeline",
      "After=network-online.target",
      "Wants=network-online.target",
      "",
      "[Service]",
      "Type=oneshot",
      "User=stavki",
      "WorkingDirectory=/opt/stavki_value_system",
      "EnvironmentFile=/etc/stavki/stavki.env",
      "Environment=PYTHONUNBUFFERED=1",
      "ExecStart=/opt/stavki_value_system/venv/bin/python3 scripts/run_odds_pipeline.py --track-lines",
      "ExecStart=/opt/stavki_value_system/venv/bin/python3 scripts/run_value_finder.py --now --telegram --auto",
      "TimeoutStartSec=600",
      "",
      "[Install]",
      "WantedBy=multi-user.target"
    ],
    "stavki.timer": [
      "[Unit]",
      "Description=Run Stavki on schedule",
      "",
      "[Timer]",
      "OnCalendar=*-*-* 12,22:00:00 UTC",
      "Persistent=true",
      "",
      "[Install]",
      "WantedBy=timers.target"
    ]
  },
  "acceptance_checks": [
    "systemctl list-timers shows stavki.timer active",
    "A scheduled run produces outputs/odds/events_latest_*.csv and audit_pack/A9_live/predictions.csv",
    "No overlapping runs occur even if a run takes > schedule interval",
    "Logs are written to /var/log/stavki and rotated",
    "Stale-run alert triggers if no success within the configured window"
  ]
}